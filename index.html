<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}

main {
  padding: 15px;
  max-width: 480px; /* para que no se vea estirado en tablet/m√≥vil grande */
  margin: auto;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 12px;
}

input, select, button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-top: 5px;
  box-sizing: border-box;
}

input.unidades {
  width: 100px; /* input m√°s corto para unidades */
}

button {
  margin-top: 12px;
  font-size: 18px;
  cursor: pointer;
}

#mensaje {
  text-align: center;
  font-weight: bold;
  margin-top: 12px;
  min-height: 24px;
}

#reader {
  width: 100%;
  margin-bottom: 12px;
}
</style>
</head>

<body>

<main>
<h2 style="text-align:center;">Planilla MEC</h2>

<label>Pickeador</label>
<select id="pickeador">
  <option value="">Seleccionar</option>
  <option>Juan</option>
  <option>Ana</option>
  <option>Carlos</option>
</select>

<label>Fecha</label>
<input type="date" id="fecha">

<label>EAN a reemplazar</label>
<div style="display:flex; gap:8px;">
  <input type="text" id="ean_origen" placeholder="Escribir o escanear" style="flex:1;">
  <button onclick="scan('ean_origen')">üì∑</button>
</div>

<label>Unidades a reemplazar</label>
<input type="number" id="uni_origen" class="unidades" min="1" max="999" inputmode="numeric" pattern="[0-9]*">

<label>EAN de reemplazo</label>
<div style="display:flex; gap:8px;">
  <input type="text" id="ean_reemplazo" placeholder="Escanear" style="flex:1;">
  <button onclick="scan('ean_reemplazo')">üì∑</button>
</div>

<label>Unidades de reemplazo</label>
<input type="number" id="uni_reemplazo" class="unidades" min="1" max="999" inputmode="numeric" pattern="[0-9]*">

<button id="btnEnviar" onclick="validar()">‚úÖ Enviar</button>

<div id="mensaje"></div>
<div id="reader"></div>
</main>

<script>
document.getElementById("fecha").valueAsDate = new Date();

/* ========= SCANNER ========= */
let html5QrCode = null;
let campoActual = "";

function scan(campo) {
  campoActual = campo;

  if (html5QrCode) {
    html5QrCode.stop().catch(() => {}).finally(() => iniciarScanner());
  } else {
    iniciarScanner();
  }
}

function iniciarScanner() {
  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 150 } },
    (text) => {
      document.getElementById(campoActual).value = text;

      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
      });
    }
  ).catch(() => {
    mostrar("No se pudo iniciar la c√°mara ‚ùå");
  });
}

/* ========= VALIDAR Y ENVIAR ========= */
function validar() {
  const btn = document.getElementById("btnEnviar");
  btn.disabled = true;

  const datos = {
    pickeador: pickeador.value,
    fecha: fecha.value,
    ean_origen: ean_origen.value.trim(),
    uni_origen: Number(uni_origen.value),
    ean_reemplazo: ean_reemplazo.value.trim(),
    uni_reemplazo: Number(uni_reemplazo.value)
  };

  if (!datos.pickeador || !datos.ean_origen || !datos.ean_reemplazo) {
    mostrar("Faltan datos obligatorios ‚ùå");
    btn.disabled = false;
    return;
  }

  if (datos.uni_origen <= 0 || datos.uni_reemplazo <= 0) {
    mostrar("Las unidades deben ser mayores a 0 ‚ùå");
    btn.disabled = false;
    return;
  }

  mostrar("Enviando datos...");

  google.script.run
    .withSuccessHandler(respuestaOK)
    .withFailureHandler(respuestaError)
    .guardarDatos(datos);
}

function respuestaOK() {
  mostrar("Datos guardados correctamente ‚úÖ", "green");
  ean_origen.value = "";
  uni_origen.value = "";
  ean_reemplazo.value = "";
  uni_reemplazo.value = "";
  document.getElementById("btnEnviar").disabled = false;
}

function respuestaError(err) {
  mostrar("Error: " + err.message, "red");
  document.getElementById("btnEnviar").disabled = false;
}

function mostrar(texto, color="black") {
  const msg = document.getElementById("mensaje");
  msg.innerText = texto;
  msg.style.color = color;
}
</script>

</body>
</html>
