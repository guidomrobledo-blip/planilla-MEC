<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f9;
}

main {
  padding: 15px;
  max-width: 500px;
  margin: auto;
}

h2 {
  text-align: center;
  color: #333;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 12px;
}

input, select, button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-top: 5px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 8px;
}

button {
  margin-top: 12px;
  background-color: #007bff;
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button:active {
  background-color: #0056b3;
}

#btnEnviar {
  background-color: #28a745;
  margin-top: 25px;
  font-size: 18px;
}

#mensaje {
  text-align: center;
  font-size: 16px;
  margin-top: 15px;
  padding: 10px;
  border-radius: 5px;
}

/* Overlay esc√°ner */
#scanner-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

#scanner-container {
  width: 85%;
  max-width: 400px;
  border: 4px solid #fff;
  border-radius: 12px;
  overflow: hidden;
}

#close-scanner {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #ff4d4d;
  color: white;
  font-size: 20px;
  border: none;
  padding: 10px 15px;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>

<body>
<main>
<h2>Planilla MEC</h2>

<label>Pickeador</label>
<select id="pickeador">
  <option value="">Seleccionar</option>
  <option>Juan</option>
  <option>Ana</option>
  <option>Carlos</option>
</select>

<label>Fecha</label>
<input type="date" id="fecha">

<hr style="margin-top:20px">

<label>EAN a reemplazar</label>
<input type="text" id="ean_origen" placeholder="Escanee o escriba EAN">
<button type="button" onclick="abrirScanner('ean_origen')">üì∑ Escanear Origen</button>

<label>Unidades a reemplazar</label>
<input type="number" id="uni_origen" min="1" value="1">

<hr style="margin-top:20px">

<label>EAN de reemplazo</label>
<input type="text" id="ean_reemplazo" placeholder="Escanee o escriba EAN">
<button type="button" onclick="abrirScanner('ean_reemplazo')">üì∑ Escanear Reemplazo</button>

<label>Unidades de reemplazo</label>
<input type="number" id="uni_reemplazo" min="1" value="1">

<button id="btnEnviar" onclick="validar()">‚úÖ GUARDAR DATOS</button>

<p id="mensaje"></p>
</main>

<div id="scanner-overlay">
  <button id="close-scanner" onclick="cerrarScanner()">X</button>
  <div id="scanner-container"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
// Poner la fecha de hoy por defecto
document.getElementById("fecha").valueAsDate = new Date();

let qrScanner;
let inputActual;

// --- CONFIGURACI√ìN ---
// REEMPLAZA ESTA URL CON LA QUE COPIASTE DE GOOGLE
const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbxymyQAzHrmo5axoTOJCBQU-B7BNfQf0HaS4mebm8gJLI6M4nna9hEUaEBPL8x-ogoeUg/exec"; 

function abrirScanner(inputId) {
  inputActual = document.getElementById(inputId);
  document.getElementById("scanner-overlay").style.display = "flex";

  qrScanner = new Html5Qrcode("scanner-container");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 150 } },
    qrCodeMessage => {
      inputActual.value = qrCodeMessage;
      // Vibraci√≥n de √©xito (100 milisegundos)
      if (navigator.vibrate) navigator.vibrate(100);
      cerrarScanner();
    }
  ).catch(err => {
    alert("Error al iniciar c√°mara: " + err);
    cerrarScanner();
  });
}

function cerrarScanner() {
  if (qrScanner) {
    qrScanner.stop().then(() => {
      qrScanner.clear();
      qrScanner = null;
    }).catch(err => console.error(err));
  }
  document.getElementById("scanner-overlay").style.display = "none";
}

async function validar() {
  const btn = document.getElementById("btnEnviar");
  const msg = document.getElementById("mensaje");
  
  // Captura de datos
  const datos = {
    pickeador: document.getElementById("pickeador").value,
    fecha: document.getElementById("fecha").value,
    ean_origen: document.getElementById("ean_origen").value.trim(),
    uni_origen: document.getElementById("uni_origen").value,
    ean_reemplazo: document.getElementById("ean_reemplazo").value.trim(),
    uni_reemplazo: document.getElementById("uni_reemplazo").value
  };

  // Validaci√≥n simple
  if (!datos.pickeador || !datos.ean_origen || !datos.ean_reemplazo) {
    mostrar("Faltan datos obligatorios ‚ùå", "red");
    return;
  }

  btn.disabled = true;
  mostrar("Enviando a la planilla... ‚è≥", "orange");

  try {
    // Env√≠o de datos a Google Sheets
    await fetch(URL_APPS_SCRIPT, {
      method: "POST",
      mode: "no-cors", 
      body: JSON.stringify(datos)
    });

    mostrar("¬°Guardado con √©xito! ‚úÖ", "green");
    
    // Limpiar campos para el siguiente pedido
    document.getElementById("ean_origen").value = "";
    document.getElementById("ean_reemplazo").value = "";
    document.getElementById("uni_origen").value = "1";
    document.getElementById("uni_reemplazo").value = "1";

  } catch (err) {
    mostrar("Error de conexi√≥n: " + err.message, "red");
  } finally {
    btn.disabled = false;
  }
}

function mostrar(texto, color) {
  const msg = document.getElementById("mensaje");
  msg.innerText = texto;
  msg.style.color = color;
  msg.style.fontWeight = "bold";
}
</script>
</body>
</html>
