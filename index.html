<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  /* --- CARROCER√çA Y PINTURA --- */
  :root {
    --azul-corporativo: #003a70;
    --gris-fondo: #f4f7f6;
    --blanco: #ffffff;
    --verde-suave: #27ae60; /* Verde Esmeralda para el bot√≥n Guardar */
  }

  body { font-family: sans-serif; margin: 0; padding: 0; background-color: var(--gris-fondo); color: #333; }
  
  header { 
    background: var(--azul-corporativo); 
    color: white; 
    padding: 15px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    position: sticky; 
    top: 0; 
    z-index: 1000;
  }

  header span { font-weight: bold; font-size: 18px; text-transform: uppercase; }

  /* CORRECCI√ìN MEN√ö: Ubicaci√≥n a la DERECHA y color BLANCO */
  #menu-btn { 
    background: none; 
    border: none; 
    font-size: 30px; 
    color: var(--blanco); /* L√≠neas blancas */
    cursor: pointer; 
    position: absolute; 
    right: 15px; /* Lado derecho */
    top: 50%; 
    transform: translateY(-50%); 
  }

  #menu-content { 
    display: none; 
    position: absolute; 
    right: 10px; 
    top: 55px; 
    background: white; 
    border-radius: 12px; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.2); 
    z-index: 1500; 
    width: 220px; 
    padding: 15px;
  }

  main { padding: 15px; max-width: 500px; margin: auto; }

  .card {
    background: var(--blanco);
    border-radius: 15px;
    padding: 18px;
    margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  label { font-weight: bold; display: block; margin-top: 10px; font-size: 14px; color: #555; }
  
  input, select { 
    width: 100%; 
    padding: 12px; 
    font-size: 16px; 
    margin-top: 5px; 
    box-sizing: border-box; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
  }

  button { 
    width: 100%; 
    padding: 14px; 
    font-size: 16px; 
    margin-top: 8px; 
    box-sizing: border-box; 
    border: none; 
    border-radius: 50px; 
    font-weight: bold; 
    cursor: pointer; 
    color: var(--blanco); /* Todos los botones con texto blanco */
  }

  .btn-scan { background-color: #6c757d; }
  
  /* Bot√≥n Guardar con texto blanco y color verde esmeralda */
  #btnEnviar { background-color: var(--verde-suave); margin-top: 20px; font-size: 18px; }

  /* Bot√≥n Cargar del men√∫ con texto blanco */
  #btnCargarMenu { background-color: #6c757d; color: var(--blanco); margin-top: 10px; }

  .detalle-container { display: none; background: #e9ecef; padding: 10px; border-radius: 8px; margin-top: 5px; border-left: 5px solid var(--azul-corporativo); }
  
  #scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; }
  #reader { width: 90%; max-width: 400px; background: white; border-radius: 15px; overflow: hidden; }
  
  #aviso-error, #aviso-duplicado { 
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    background-color: white; 
    padding: 20px; 
    border-radius: 12px; 
    z-index: 3000; 
    width: 80%; 
    text-align: center; 
    box-shadow: 0 0 20px rgba(0,0,0,0.5); 
    border: 3px solid red;
  }

  #mensaje { text-align: center; margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>

<header>
  <span>REEMPLAZOS MEC</span>
  <button id="menu-btn" onclick="toggleMenu()">‚ò∞</button>
  <div id="menu-content">
    <label style="margin:0; color: #333; font-size: 14px;">Fila a Corregir:</label>
    <input type="number" id="input_fila" inputmode="numeric" placeholder="Ej: 5">
    <button id="btnCargarMenu" onclick="cargarFila()">Cargar</button>
  </div>
</header>

<div id="aviso-error">
  <p style="color: red; font-weight: bold;">‚ö†Ô∏è ATENCI√ìN: Los EAN son iguales</p>
  <button onclick="cerrarAviso('aviso-error')" style="background-color: #6c757d;">Cerrar</button>
</div>

<div id="aviso-duplicado">
  <p id="msg-duplicado" style="color: red; font-weight: bold;"></p>
  <button onclick="cerrarAviso('aviso-duplicado')" style="background-color: #6c757d;">Cerrar</button>
</div>

<main>
  <h2 id="titulo-modo" style="text-align: center; font-size: 18px;">Nueva Carga</h2>
  
  <div class="card">
    <label>Pickeador</label>
    <select id="pickeador"><option value="">Seleccionar</option><option>Juan</option><option>Ana</option><option>Carlos</option></select>
    
    <label>Nro Pedido</label>
    <input type="text" id="nro_pedido" inputmode="numeric">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('nro_pedido')">üì∑ Escanear Pedido</button>
    
    <label>Fecha</label>
    <input type="date" id="fecha">
  </div>

  <div class="card">
    <label>EAN Origen</label>
    <input type="text" id="ean_origen" inputmode="numeric" oninput="checkEAN(this, 'cont_origen')">
    <div id="cont_origen" class="detalle-container">
      <label style="font-size:12px">Detalle Origen (Pesable):</label>
      <input type="text" id="det_origen">
    </div>

    <label>Unidades</label>
    <input type="text" id="uni_origen" inputmode="decimal" value="1">
  </div>

  <div class="card">
    <label>EAN Reemplazo</label>
    <input type="text" id="ean_reemplazo" inputmode="numeric" oninput="checkEAN(this, 'cont_reemplazo')">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('ean_reemplazo')">üì∑ Escanear Reemplazo</button>
    <div id="cont_reemplazo" class="detalle-container">
      <label style="font-size:12px">Detalle Reemplazo (Pesable):</label>
      <input type="text" id="det_reemplazo">
    </div>

    <label>Unidades</label>
    <input type="text" id="uni_reemplazo" inputmode="decimal" value="1">
  </div>
  
  <button id="btnEnviar" onclick="validar()">‚úÖ GUARDAR DATOS</button>
  <button id="btnCancelar" onclick="cancelarEdicion()" style="display:none; background:#dc3545; margin-top:10px">‚ùå CANCELAR EDICI√ìN</button>
  <p id="mensaje"></p>
</main>

<div id="scanner-modal">
  <div id="reader"></div>
  <button onclick="detenerEscaneo()" style="width: 60px; height: 60px; border-radius: 50%; background: white; color: red; margin-top: 20px;">X</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  /* --- EL MOTOR SIGUE INTACTO --- */
  const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbxymyQAzHrmo5axoTOJCBQU-B7BNfQf0HaS4mebm8gJLI6M4nna9hEUaEBPL8x-ogoeUg/exec"; 
  let html5QrCode, campoDestino, modoEdicion = false, filaEdicion = null;
  document.getElementById("fecha").valueAsDate = new Date();

  function vibrar() { if (navigator.vibrate) navigator.vibrate(200); }

  function checkEAN(input, containerId) {
    const val = input.value.trim();
    const prefijos = ["23", "25", "26", "29"];
    const container = document.getElementById(containerId);
    container.style.display = prefijos.some(p => val.startsWith(p)) ? "block" : "none";
  }

  function formatearUnidad(valor) {
    let s = valor.toString().replace(',', '.').trim();
    if (!s) return "0";
    if (s.startsWith('.') || s.startsWith(',')) s = "0." + s.substring(1);
    return s.includes('.') ? parseFloat(s) + " kg" : s;
  }

  function toggleMenu() {
    const m = document.getElementById("menu-content");
    m.style.display = m.style.display === "block" ? "none" : "block";
  }

  async function cargarFila() {
    const nro = document.getElementById("input_fila").value;
    if(!nro) return;
    mostrar("Buscando... ‚è≥", "orange"); toggleMenu();
    try {
      const resp = await fetch(URL_APPS_SCRIPT + "?nro_fila=" + nro);
      const d = await resp.json();
      if(d.status === "error") { mostrar("No encontrada", "red"); return; }
      
      document.getElementById("pickeador").value = d.pickeador;
      document.getElementById("nro_pedido").value = d.nro_pedido;
      document.getElementById("fecha").value = d.fecha;
      document.getElementById("ean_origen").value = d.ean_origen;
      document.getElementById("uni_origen").value = d.uni_origen.toString().replace(" kg","");
      document.getElementById("ean_reemplazo").value = d.ean_reemplazo;
      document.getElementById("uni_reemplazo").value = d.uni_reemplazo.toString().replace(" kg","");
      document.getElementById("det_origen").value = d.det_origen || "";
      document.getElementById("det_reemplazo").value = d.det_reemplazo || "";
      
      checkEAN(document.getElementById("ean_origen"), 'cont_origen');
      checkEAN(document.getElementById("ean_reemplazo"), 'cont_reemplazo');
      
      modoEdicion = true; filaEdicion = nro;
      document.getElementById("titulo-modo").innerText = "Corrigiendo Fila " + nro;
      document.getElementById("btnEnviar").innerText = "üîÑ ACTUALIZAR FILA " + nro;
      document.getElementById("btnEnviar").style.background = "#fd7e14";
      document.getElementById("btnCancelar").style.display = "block";
      mostrar("Cargado ‚úÖ", "blue");
    } catch (e) { mostrar("Error lectura ‚ùå", "red"); }
  }

  function iniciarEscaneo(id) {
    campoDestino = id; document.getElementById("scanner-modal").style.display = "flex";
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } },
      (text) => { 
        vibrar();
        document.getElementById(campoDestino).value = text.trim(); 
        if (campoDestino === 'ean_reemplazo') checkEAN(document.getElementById(campoDestino), 'cont_reemplazo');
        detenerEscaneo(); 
      }, () => {}
    ).catch(() => { alert("Error c√°mara"); detenerEscaneo(); });
  }

  function detenerEscaneo() {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => { document.getElementById("scanner-modal").style.display = "none"; });
    } else { document.getElementById("scanner-modal").style.display = "none"; }
  }

  async function validar() {
    const btn = document.getElementById("btnEnviar");
    const datos = {
      accion: modoEdicion ? "actualizar" : "insertar",
      nro_fila: filaEdicion,
      pickeador: document.getElementById("pickeador").value,
      nro_pedido: document.getElementById("nro_pedido").value.trim(),
      fecha: document.getElementById("fecha").value,
      ean_origen: document.getElementById("ean_origen").value.trim(),
      uni_origen: formatearUnidad(document.getElementById("uni_origen").value),
      ean_reemplazo: document.getElementById("ean_reemplazo").value.trim(),
      uni_reemplazo: formatearUnidad(document.getElementById("uni_reemplazo").value),
      det_origen: document.getElementById("det_origen").value.trim(),
      det_reemplazo: document.getElementById("det_reemplazo").value.trim()
    };

    if (!datos.pickeador || !datos.nro_pedido || !datos.ean_origen || !datos.ean_reemplazo) {
      mostrar("Faltan datos ‚ùå", "red"); return;
    }
    if (datos.ean_origen === datos.ean_reemplazo) {
      document.getElementById("aviso-error").style.display = "block"; return;
    }

    btn.disabled = true; mostrar("Validando y enviando... ‚è≥", "orange");
    try {
      const resp = await fetch(URL_APPS_SCRIPT, { method: "POST", body: JSON.stringify(datos) });
      const resJson = await resp.json();
      
      if (resJson.status === "duplicado") {
        document.getElementById("msg-duplicado").innerText = resJson.mensaje;
        document.getElementById("aviso-duplicado").style.display = "block";
        mostrar("Error: Duplicado ‚ùå", "red");
      } else {
        mostrar("√âxito ‚úÖ", "green");
        if (modoEdicion) cancelarEdicion();
        else { 
          document.getElementById("ean_origen").value = ""; document.getElementById("ean_reemplazo").value = "";
          document.getElementById("uni_origen").value = "1"; document.getElementById("uni_reemplazo").value = "1";
          document.querySelectorAll('.detalle-container').forEach(c => c.style.display = "none");
        }
      }
    } catch (err) { mostrar("Error de red ‚ùå", "red"); }
    finally { btn.disabled = false; }
  }

  function cancelarEdicion() {
    modoEdicion = false; filaEdicion = null;
    document.getElementById("titulo-modo").innerText = "Nueva Carga";
    document.getElementById("btnEnviar").innerText = "‚úÖ GUARDAR DATOS";
    document.getElementById("btnEnviar").style.background = "var(--verde-suave)";
    document.getElementById("btnCancelar").style.display = "none";
    mostrar("Edici√≥n cancelada", "black");
  }

  function cerrarAviso(id) { document.getElementById(id).style.display = "none"; }
  function mostrar(t, c) { const m = document.getElementById("mensaje"); m.innerText = t; m.style.color = c; }
</script>
</body>
</html>
