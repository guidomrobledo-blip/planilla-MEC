<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#003a70">

<style>
  :root {
    --azul-corporativo: #003a70;
    --gris-fondo: #f4f7f6;
    --blanco: #ffffff;
    --verde-exito: #28a745;
    --naranja-edit: #fd7e14;
    --rojo-error: #dc3545;
  }

  body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--gris-fondo); color: #333; padding-bottom: 100px; }
  
  header { 
    background: var(--azul-corporativo); 
    color: white; 
    padding: 15px; 
    text-align: center;
    position: sticky; 
    top: 0; 
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  header span { font-weight: bold; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }

  main { padding: 15px; max-width: 500px; margin: auto; }

  .card {
    background: var(--blanco);
    border-radius: 15px;
    padding: 18px;
    margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .card-title {
    font-size: 13px;
    font-weight: bold;
    color: var(--azul-corporativo);
    margin-bottom: 12px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
    text-transform: uppercase;
  }
  
  label { font-weight: 600; display: block; margin-top: 10px; font-size: 14px; color: #555; }
  
  input, select { 
    width: 100%; padding: 12px; font-size: 16px; margin-top: 5px; 
    box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd;
  }

  /* BARRA INFERIOR */
  .bottom-nav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 450px;
    background: #333;
    height: 70px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    z-index: 2000;
    transition: background 0.3s;
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
    text-decoration: none;
    font-size: 10px;
    background: none;
    border: none;
    cursor: pointer;
  }

  .nav-item i { font-size: 24px; margin-bottom: 2px; }

  /* BOT√ìN CENTRAL DIN√ÅMICO */
  .btn-main {
    background: var(--verde-exito);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 50px;
    font-weight: bold;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    min-width: 160px;
    justify-content: center;
  }

  /* ESTADOS DE BARRA */
  .nav-edit-mode { background: #555; }

  /* BOTONES ESC√ÅNER INTERNOS */
  .btn-scan { background-color: #f0f0f0; color: var(--azul-corporativo); border: 1px solid var(--azul-corporativo); width: 100%; padding: 10px; border-radius: 50px; font-weight: bold; margin-top: 8px; cursor: pointer; }

  .detalle-container { display: none; background: #eef2ff; padding: 12px; border-radius: 10px; margin-top: 8px; border-left: 5px solid var(--azul-corporativo); }
  
  #scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; }
  #reader { width: 90%; max-width: 400px; background: white; border-radius: 15px; overflow: hidden; }
  
  /* MODALES */
  .modal-aviso { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 20px; z-index: 4000; width: 80%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

  #mensaje-flotante { text-align: center; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
</style>
</head>
<body>

<header>
  <span id="header-text">REEMPLAZOS MEC</span>
</header>

<main>
  <div id="mensaje-flotante"></div>

  <div class="card">
    <div class="card-title">Informaci√≥n de Pedido</div>
    <label>Pickeador</label>
    <select id="pickeador">
      <option value="">Seleccionar</option>
      <option>Juan</option><option>Ana</option><option>Carlos</option>
    </select>
    
    <label>Nro Pedido</label>
    <input type="text" id="nro_pedido" inputmode="numeric">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('nro_pedido')">üì∑ Escanear Pedido</button>
    
    <label>Fecha</label>
    <input type="date" id="fecha">
  </div>

  <div class="card">
    <div class="card-title">Producto Original</div>
    <label>EAN Origen</label>
    <input type="text" id="ean_origen" inputmode="numeric" oninput="checkEAN(this, 'cont_origen')">
    <div id="cont_origen" class="detalle-container">
      <label style="font-size:12px">Detalle Origen (Pesable):</label>
      <input type="text" id="det_origen">
    </div>
    <label>Unidades</label>
    <input type="text" id="uni_origen" inputmode="decimal" value="1">
  </div>

  <div class="card">
    <div class="card-title">Producto Reemplazo</div>
    <label>EAN Reemplazo</label>
    <input type="text" id="ean_reemplazo" inputmode="numeric" oninput="checkEAN(this, 'cont_reemplazo')">
    <button type="button" class="btn-scan" onclick="iniciarEscaneo('ean_reemplazo')">üì∑ Escanear Reemplazo</button>
    <div id="cont_reemplazo" class="detalle-container">
      <label style="font-size:12px">Detalle Reemplazo (Pesable):</label>
      <input type="text" id="det_reemplazo">
    </div>
    <label>Unidades</label>
    <input type="text" id="uni_reemplazo" inputmode="decimal" value="1">
  </div>
</main>

<nav class="bottom-nav" id="bottomNav">
  <button class="nav-item" id="btnIzquierdo" onclick="accionIzquierda()">
    <span style="font-size:24px" id="iconIzquierdo">‚ûï</span>
    <span id="txtIzquierdo">Nuevo</span>
  </button>

  <button class="btn-main" id="btnCentro" onclick="validar()">
    <span id="txtCentro">GUARDAR DATOS</span>
  </button>

  <button class="nav-item" id="btnDerecho" onclick="accionDerecha()">
    <span style="font-size:24px" id="iconDerecho">‚úèÔ∏è</span>
    <span id="txtDerecho">Editar</span>
  </button>
</nav>

<div id="aviso-error" class="modal-aviso">
  <p style="font-size: 40px; margin: 0;">‚ö†Ô∏è</p>
  <p style="color: red; font-weight: bold;">EAN IGUALES</p>
  <button onclick="cerrarAviso('aviso-error')" style="background:#666; color:white; border:none; padding:10px 20px; border-radius:50px;">Cerrar</button>
</div>

<div id="aviso-confirmar-borrar" class="modal-aviso">
  <p style="font-size: 40px; margin: 0;">üóëÔ∏è</p>
  <p>¬øSeguro que quieres <b>ELIMINAR</b> la fila <span id="nro-fila-borrar"></span>?</p>
  <div style="display:flex; gap:10px; justify-content:center;">
    <button onclick="ejecutarEliminar()" style="background:var(--rojo-error); color:white; border:none; padding:10px; border-radius:10px; flex:1;">S√ç, ELIMINAR</button>
    <button onclick="cerrarAviso('aviso-confirmar-borrar')" style="background:#ccc; border:none; padding:10px; border-radius:10px; flex:1;">NO</button>
  </div>
</div>

<div id="scanner-modal">
  <div id="reader"></div>
  <button onclick="detenerEscaneo()" style="width: 60px; height: 60px; border-radius: 50%; background: white; color: red; margin-top: 20px; font-weight: bold;">X</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbxymyQAzHrmo5axoTOJCBQU-B7BNfQf0HaS4mebm8gJLI6M4nna9hEUaEBPL8x-ogoeUg/exec"; 
  let html5QrCode, campoDestino, modoEdicion = false, filaEdicion = null;
  document.getElementById("fecha").valueAsDate = new Date();

  function vibrar() { if (navigator.vibrate) navigator.vibrate(200); }

  function checkEAN(input, containerId) {
    const val = input.value.trim();
    const prefijos = ["23", "25", "26", "29"];
    const container = document.getElementById(containerId);
    container.style.display = prefijos.some(p => val.startsWith(p)) ? "block" : "none";
  }

  function mostrar(t, c) { 
    const m = document.getElementById("mensaje-flotante"); 
    m.innerText = t; m.style.color = c; 
    if(c === 'green') setTimeout(() => m.innerText = "", 3000);
  }

  function accionIzquierda() {
    if (modoEdicion) cancelarEdicion();
    else {
      if(confirm("¬øLimpiar todos los campos?")) {
        document.querySelectorAll("input").forEach(i => i.value = "");
        document.getElementById("fecha").valueAsDate = new Date();
        document.getElementById("uni_origen").value = "1";
        document.getElementById("uni_reemplazo").value = "1";
        mostrar("Campos limpios", "black");
      }
    }
  }

  async function accionDerecha() {
    if (modoEdicion) {
      document.getElementById("nro-fila-borrar").innerText = filaEdicion;
      document.getElementById("aviso-confirmar-borrar").style.display = "block";
    } else {
      const nro = prompt("Ingrese el n√∫mero de fila a editar:");
      if (!nro) return;
      cargarFila(nro);
    }
  }

  async function cargarFila(nro) {
    mostrar("Buscando fila " + nro + "... ‚è≥", "orange");
    try {
      const resp = await fetch(URL_APPS_SCRIPT + "?nro_fila=" + nro);
      const d = await resp.json();
      if(d.status === "error") { mostrar("Fila no encontrada", "red"); return; }
      
      document.getElementById("pickeador").value = d.pickeador;
      document.getElementById("nro_pedido").value = d.nro_pedido;
      document.getElementById("fecha").value = d.fecha;
      document.getElementById("ean_origen").value = d.ean_origen;
      document.getElementById("uni_origen").value = d.uni_origen.toString().replace(" kg","");
      document.getElementById("ean_reemplazo").value = d.ean_reemplazo;
      document.getElementById("uni_reemplazo").value = d.uni_reemplazo.toString().replace(" kg","");
      document.getElementById("det_origen").value = d.det_origen || "";
      document.getElementById("det_reemplazo").value = d.det_reemplazo || "";
      
      checkEAN(document.getElementById("ean_origen"), 'cont_origen');
      checkEAN(document.getElementById("ean_reemplazo"), 'cont_reemplazo');
      
      activarModoEdicion(nro);
      mostrar("Fila " + nro + " cargada", "blue");
    } catch (e) { mostrar("Error de conexi√≥n", "red"); }
  }

  function activarModoEdicion(nro) {
    modoEdicion = true; filaEdicion = nro;
    document.getElementById("header-text").innerText = "CORRIGIENDO FILA " + nro;
    document.getElementById("bottomNav").classList.add("nav-edit-mode");
    
    // Cambios en botones
    document.getElementById("iconIzquierdo").innerText = "‚ùå";
    document.getElementById("txtIzquierdo").innerText = "Cancelar";
    
    document.getElementById("btnCentro").style.background = "var(--naranja-edit)";
    document.getElementById("txtCentro").innerText = "ACTUALIZAR FILA " + nro;
    
    document.getElementById("iconDerecho").innerText = "üóëÔ∏è";
    document.getElementById("txtDerecho").innerText = "Eliminar";
  }

  function cancelarEdicion() {
    modoEdicion = false; filaEdicion = null;
    document.getElementById("header-text").innerText = "REEMPLAZOS MEC";
    document.getElementById("bottomNav").classList.remove("nav-edit-mode");
    
    document.getElementById("iconIzquierdo").innerText = "‚ûï";
    document.getElementById("txtIzquierdo").innerText = "Nuevo";
    
    document.getElementById("btnCentro").style.background = "var(--verde-exito)";
    document.getElementById("txtCentro").innerText = "GUARDAR DATOS";
    
    document.getElementById("iconDerecho").innerText = "‚úèÔ∏è";
    document.getElementById("txtDerecho").innerText = "Editar";
    mostrar("Edici√≥n cancelada", "black");
  }

  async function ejecutarEliminar() {
    cerrarAviso('aviso-confirmar-borrar');
    mostrar("Eliminando fila... ‚è≥", "red");
    try {
      const resp = await fetch(URL_APPS_SCRIPT, {
        method: "POST",
        body: JSON.stringify({ accion: "eliminar", nro_fila: filaEdicion })
      });
      vibrar();
      mostrar("Eliminado con √©xito ‚úÖ", "green");
      cancelarEdicion();
    } catch (e) { mostrar("Error al eliminar", "red"); }
  }

  function iniciarEscaneo(id) {
    campoDestino = id; document.getElementById("scanner-modal").style.display = "flex";
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } },
      (text) => { 
        vibrar();
        document.getElementById(campoDestino).value = text.trim(); 
        if (campoDestino === 'ean_reemplazo') checkEAN(document.getElementById(campoDestino), 'cont_reemplazo');
        detenerEscaneo(); 
      }, () => {}
    ).catch(() => { alert("Error c√°mara"); detenerEscaneo(); });
  }

  function detenerEscaneo() {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => { document.getElementById("scanner-modal").style.display = "none"; });
    } else { document.getElementById("scanner-modal").style.display = "none"; }
  }

  async function validar() {
    const datos = {
      accion: modoEdicion ? "actualizar" : "insertar",
      nro_fila: filaEdicion,
      pickeador: document.getElementById("pickeador").value,
      nro_pedido: document.getElementById("nro_pedido").value.trim(),
      fecha: document.getElementById("fecha").value,
      ean_origen: document.getElementById("ean_origen").value.trim(),
      uni_origen: formatearUnidad(document.getElementById("uni_origen").value),
      ean_reemplazo: document.getElementById("ean_reemplazo").value.trim(),
      uni_reemplazo: formatearUnidad(document.getElementById("uni_reemplazo").value),
      det_origen: document.getElementById("det_origen").value.trim(),
      det_reemplazo: document.getElementById("det_reemplazo").value.trim()
    };

    if (!datos.pickeador || !datos.nro_pedido || !datos.ean_origen || !datos.ean_reemplazo) {
      mostrar("Faltan datos ‚ùå", "red"); return;
    }
    if (datos.ean_origen === datos.ean_reemplazo) {
      document.getElementById("aviso-error").style.display = "block"; return;
    }

    mostrar("Enviando... ‚è≥", "orange");
    try {
      const resp = await fetch(URL_APPS_SCRIPT, { method: "POST", body: JSON.stringify(datos) });
      const resJson = await resp.json();
      
      if (resJson.status === "duplicado") {
        alert(resJson.mensaje);
        mostrar("Error: Duplicado", "red");
      } else {
        vibrar();
        mostrar("¬°√âxito! ‚úÖ", "green");
        if (modoEdicion) cancelarEdicion();
        else { 
          document.getElementById("ean_origen").value = ""; document.getElementById("ean_reemplazo").value = "";
          document.getElementById("uni_origen").value = "1"; document.getElementById("uni_reemplazo").value = "1";
          document.querySelectorAll('.detalle-container').forEach(c => c.style.display = "none");
        }
      }
    } catch (err) { mostrar("Error de red", "red"); }
  }

  function formatearUnidad(v) {
    let s = v.toString().replace(',', '.').trim();
    if (!s) return "0";
    return s.includes('.') ? parseFloat(s) + " kg" : s;
  }

  function cerrarAviso(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
