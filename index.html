<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MEC ‚Äì Reemplazos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}

main {
  padding: 15px;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 12px;
}

input, select, button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-top: 5px;
  box-sizing: border-box;
}

button {
  margin-top: 12px;
}

/* Mensajes en el centro */
#mensaje {
  text-align: center;
  font-size: 16px;
  margin-top: 10px;
}

/* Overlay esc√°ner */
#scanner-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

#scanner-overlay video, #scanner-container {
  width: 90%;
  max-width: 600px;
  border: 2px solid #fff;
  border-radius: 8px;
}

/* Bot√≥n cerrar */
#close-scanner {
  position: absolute;
  top: 20px;
  right: 20px;
  background: red;
  color: white;
  font-size: 20px;
  border: none;
  padding: 5px 12px;
  border-radius: 4px;
  cursor: pointer;
}
</style>
</head>

<body>
<main>
<h2>Planilla MEC</h2>

<label>Pickeador</label>
<select id="pickeador">
  <option value="">Seleccionar</option>
  <option>Juan</option>
  <option>Ana</option>
  <option>Carlos</option>
</select>

<label>Fecha</label>
<input type="date" id="fecha">

<label>EAN a reemplazar</label>
<input type="text" id="ean_origen" inputmode="numeric" pattern="\d*">

<button type="button" onclick="abrirScanner('ean_origen')">üì∑ Escanear EAN</button>

<label>Unidades a reemplazar</label>
<input type="number" id="uni_origen" min="1" inputmode="numeric" pattern="\d*">

<label>EAN de reemplazo</label>
<input type="text" id="ean_reemplazo" inputmode="numeric" pattern="\d*">

<button type="button" onclick="abrirScanner('ean_reemplazo')">üì∑ Escanear EAN</button>

<label>Unidades de reemplazo</label>
<input type="number" id="uni_reemplazo" min="1" inputmode="numeric" pattern="\d*">

<button id="btnEnviar" onclick="validar()">‚úÖ Enviar</button>

<p id="mensaje"></p>
</main>

<!-- Overlay esc√°ner -->
<div id="scanner-overlay">
  <button id="close-scanner" onclick="cerrarScanner()">X</button>
  <div id="scanner-container"></div>
</div>

<!-- Librer√≠a html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
document.getElementById("fecha").valueAsDate = new Date();

let qrScanner;
let inputActual; // Guardar input que activ√≥ esc√°ner

function abrirScanner(inputId) {
  inputActual = document.getElementById(inputId);
  document.getElementById("scanner-overlay").style.display = "flex";

  qrScanner = new Html5Qrcode("scanner-container");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      inputActual.value = qrCodeMessage;
      cerrarScanner();
    }
  ).catch(err => {
    mostrar("Error al iniciar c√°mara: " + err);
    cerrarScanner();
  });
}

function cerrarScanner() {
  if (qrScanner) {
    qrScanner.stop().then(() => {
      qrScanner.clear();
      qrScanner = null;
    }).catch(err => console.error("Error detener esc√°ner:", err));
  }
  document.getElementById("scanner-overlay").style.display = "none";
}

function validar() {
  const btn = document.getElementById("btnEnviar");
  btn.disabled = true;

  const datos = {
    pickeador: pickeador.value,
    fecha: fecha.value,
    ean_origen: ean_origen.value.trim(),
    uni_origen: Number(uni_origen.value),
    ean_reemplazo: ean_reemplazo.value.trim(),
    uni_reemplazo: Number(uni_reemplazo.value)
  };

  if (!datos.pickeador || !datos.ean_origen || !datos.ean_reemplazo) {
    mostrar("Faltan datos obligatorios ‚ùå", "red");
    btn.disabled = false;
    return;
  }

  if (datos.uni_origen <= 0 || datos.uni_reemplazo <= 0) {
    mostrar("Las unidades deben ser mayores a 0 ‚ùå", "red");
    btn.disabled = false;
    return;
  }

  mostrar("Enviando datos...", "black");

  google.script.run
    .withSuccessHandler(() => {
      mostrar("Datos guardados correctamente ‚úÖ", "green");
      ean_origen.value = "";
      uni_origen.value = "";
      ean_reemplazo.value = "";
      uni_reemplazo.value = "";
      btn.disabled = false;
    })
    .withFailureHandler(err => {
      mostrar("Error: " + err.message, "red");
      btn.disabled = false;
    })
    .guardarDatos(datos);
}

function mostrar(texto, color = "black") {
  const msg = document.getElementById("mensaje");
  msg.innerText = texto;
  msg.style.color = color;
  msg.style.fontWeight = "bold";
}
</script>
</body>
</html>
